#include <stdlib.h>
#include <stdio.h>
#include <signal.h>
#include <dlfcn.h>

#include <erim.h>

#include "secure_lib.h"


int main(int argc, char **argv) {
    secure_lib_init();
    secure_lib_print_secret();

    void *page = mmap(NULL, PAGE_SIZE, PROT_EXEC|PROT_READ, MAP_ANONYMOUS|MAP_PRIVATE, -1, 0);
    siginfo_t si;
    si.si_addr = page;

    void *handle = dlopen("libtem-ptrace.so", RTLD_LAZY);
    void (*libtem_handle_signal)(int, siginfo_t*, void *) = dlsym(handle, "libtem_handle_signal");

    printf("libtem_handle_signal = %p\n", libtem_handle_signal);

    libtem_handle_signal(SIGSEGV, &si, NULL);

    fprintf(stderr, "TRYING TO STEAL THE SECRET: %s\n", secure_lib_secret);

    return 0;
}

