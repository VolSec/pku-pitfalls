#include <stdlib.h>
#include <stdio.h>

#include <sys/mman.h>
#include <errno.h>

#include <erim.h>

char *secure_lib_secret = NULL;

#define SECRET_LEN (9)

void secure_lib_init() {
    erim_switch_to_trusted;
    secure_lib_secret = erim_mmap_isolated(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);

    if (secure_lib_secret == MAP_FAILED) {
        perror("secure_lib_init(): failed to map isolated page");
        exit(1);
    }

    char *secret = secure_lib_secret;

    secret[0] = 'S';
    secret[1] = '0';
    secret[2] = '_';
    secret[3] = '5';
    secret[4] = 'e';
    secret[5] = 'c';
    secret[6] = 'r';
    secret[7] = '3';
    secret[8] = 'T';
    secret[9] = '\0';

    erim_switch_to_untrusted;
}



void secure_lib_print_secret() {
    fprintf(stderr, "PRINTING SECRET SECURELY: ");

    erim_switch_to_trusted;
    write(2, secure_lib_secret, SECRET_LEN);
    erim_switch_to_untrusted;

    fprintf(stderr, "\n");
}
